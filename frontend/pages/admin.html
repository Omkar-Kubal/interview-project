<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Signal Capture Console - Recruiter Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#000000",
                        "background-light": "#ffffff",
                        "background-tech": "#f4f4f5",
                        "surface": "#ffffff",
                        "border-tech": "#000000",
                        "text-main": "#000000",
                        "text-muted": "#52525b",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "mono": ["ui-monospace", "SFMono-Regular", "Menlo", "Monaco", "Consolas", "monospace"],
                    },
                    borderRadius: {
                        "DEFAULT": "0px",
                        "sm": "0px",
                        "md": "0px",
                        "lg": "0px",
                        "xl": "0px",
                        "full": "0px"
                    },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #ffffff;
            border-left: 1px solid #000000;
        }

        ::-webkit-scrollbar-thumb {
            background: #000000;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #333333;
        }

        .technical-grid {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        }

        .tech-border {
            border: 1px solid #000000;
        }

        .tech-button-solid {
            background-color: #000000;
            color: #ffffff;
            border: 1px solid #000000;
        }

        .tech-button-solid:hover {
            background-color: #333333;
        }

        .tech-button-outline {
            background-color: transparent;
            color: #000000;
            border: 1px solid #000000;
        }

        .tech-button-outline:hover {
            background-color: #f4f4f5;
        }
    </style>
</head>

<body
    class="bg-background-light text-text-main font-display overflow-hidden flex flex-col h-screen antialiased selection:bg-black selection:text-white">
    <header class="h-16 border-b border-border-tech bg-white flex items-center justify-between px-6 shrink-0 z-10">
        <div class="flex items-center gap-4 cursor-pointer" onclick="window.location.href='/'">
            <div class="flex items-center justify-center size-8 bg-black text-white border border-black">
                <span class="material-symbols-outlined text-lg">graphic_eq</span>
            </div>
            <div class="flex flex-col">
                <h1 class="text-lg font-bold tracking-widest uppercase text-black leading-none">Signal Capture Console -
                    Recruiter Admin</h1>
                <span class="text-[10px] text-text-muted tracking-[0.2em] uppercase mt-1 font-mono">Build 9.1 //
                    Raw_Input_Mode</span>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="hidden md:flex items-center gap-2 text-xs font-mono text-black border border-black px-2 py-1">
                <span class="size-2 bg-black animate-pulse"></span>
                <span>DATA_STREAM_ACTIVE</span>
            </div>
            <div class="h-8 w-[1px] bg-border-tech mx-2"></div>
            <div class="flex items-center gap-4">
                <span id="operator-id"
                    class="text-xs font-bold uppercase tracking-wider font-mono text-right hidden sm:block">
                    OPERATOR_ID: ADMIN_PENDING
                </span>
                <button onclick="sessionStorage.clear(); window.location.href='/login';"
                    class="ml-2 p-2 hover:bg-gray-100 border border-transparent hover:border-black text-black transition-all">
                    <span class="material-symbols-outlined">logout</span>
                </button>
            </div>
        </div>
    </header>
    <main class="flex-1 flex overflow-hidden relative technical-grid bg-white">
        <section
            class="w-full lg:w-[450px] flex flex-col border-r border-border-tech bg-white/95 backdrop-blur-sm shrink-0">
            <div class="p-5 border-b border-border-tech flex items-center justify-between bg-background-tech">
                <h2 class="text-sm font-bold tracking-tight text-black uppercase flex items-center gap-2">
                    <span class="material-symbols-outlined text-base">folder_open</span>
                    Job Management
                </h2>
                <div class="flex gap-2">
                    <button
                        class="p-1.5 hover:bg-gray-200 border border-transparent hover:border-black text-black transition-all">
                        <span class="material-symbols-outlined text-lg">add</span>
                    </button>
                </div>
            </div>
            <div id="job-list" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="p-8 text-center font-mono text-xs text-gray-400 uppercase tracking-widest">
                    Polling Job Database...
                </div>
            </div>
        </section>
        <section class="flex-1 flex flex-col bg-white relative overflow-hidden">
            <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-black"></div>
            <div class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-black"></div>
            <div class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-black"></div>
            <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-black"></div>
            <div class="p-6 pb-2">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-black tracking-tight uppercase">Applicant Pipeline</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="target-job-title"
                                class="text-xs text-black font-bold font-mono uppercase bg-gray-100 px-2 py-0.5">SELECT
                                A JOB TO START</span>
                            <span class="h-px w-8 bg-black"></span>
                            <span id="signal-count"
                                class="text-[10px] text-text-muted uppercase tracking-wider font-mono">BUFFER: 0
                                SIGNALS</span>
                        </div>
                    </div>
                </div>
                <div
                    class="grid grid-cols-12 gap-4 px-4 py-3 bg-black text-white border-y border-black text-[10px] uppercase tracking-widest font-bold font-mono">
                    <div class="col-span-3">Candidate ID</div>
                    <div class="col-span-3">Applied Date</div>
                    <div class="col-span-2">Status</div>
                    <div class="col-span-4 text-right pr-2">Actions</div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-6 pb-6">
                <div id="pipeline-container" class="flex flex-col gap-0 border border-black">
                    <div class="p-12 text-center font-mono text-xs text-gray-400 uppercase tracking-widest">
                        Awaiting Signal Selection...
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer
        class="h-10 bg-black border-t border-black flex items-center justify-between px-6 text-[10px] uppercase font-mono tracking-widest text-white shrink-0 z-20">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <div class="size-2 bg-white animate-pulse"></div>
                <span class="font-bold">System Ready</span>
            </div>
            <div class="flex items-center gap-2 opacity-70">
                <span>Server:</span>
                <span>Local_Host_01</span>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 font-bold">
                <span class="material-symbols-outlined text-xs">wifi_lock</span>
                <span>Secured Data Stream</span>
            </div>
        </div>
    </footer>

    <script>
        const user = JSON.parse(sessionStorage.getItem('user'));
        const token = sessionStorage.getItem('token');

        if (!token || (user.role !== 'admin' && user.role !== 'recruiter')) {
            window.location.href = '/login';
        }

        document.getElementById('operator-id').innerText = `OPERATOR_ID: ${user.full_name || 'ADMIN'}`;

        if (user.role === 'admin') {
            const headerActions = document.querySelector('header .flex.items-center.gap-6');
            const switcher = document.createElement('a');
            switcher.href = '/dashboard';
            switcher.className = 'text-xs font-bold text-black border border-black px-4 py-2 hover:bg-gray-100 transition-all uppercase tracking-widest';
            switcher.innerText = 'Go to Candidate View';
            headerActions.prepend(switcher);
        }

        let currentJobId = null;

        async function fetchJobs() {
            try {
                const response = await fetch(`/api/jobs/recruiter/${user.id}`);
                const jobs = await response.json();
                renderJobs(jobs);
            } catch (error) {
                console.error('Job Fetch Error:', error);
            }
        }

        function renderJobs(jobs) {
            const list = document.getElementById('job-list');
            if (jobs.length === 0) {
                list.innerHTML = '<div class="p-8 text-center font-mono text-xs text-gray-400 uppercase tracking-widest">NO_POSTED_JOBS</div>';
                return;
            }

            list.innerHTML = jobs.map(job => `
                <div onclick="selectJob(${job.id}, '${job.title.replace(/'/g, "\\'")}')" 
                     class="group relative p-4 border ${currentJobId === job.id ? 'border-2 border-black bg-gray-50' : 'border-gray-300 bg-white'} cursor-pointer hover:bg-gray-50 transition-all shadow-none">
                    <div class="flex justify-between items-start mb-3">
                        <div class="pr-8">
                            <h3 class="text-sm font-bold text-black uppercase tracking-wide">${job.title}</h3>
                            <p class="text-[10px] text-text-muted mt-1 font-mono">REF: J-${job.id}</p>
                        </div>
                    </div>
                    <div class="flex items-end justify-between mt-4">
                        <div class="flex items-center gap-2">
                            <div class="size-3 ${job.is_active ? 'bg-black' : 'border border-black'}"></div>
                            <span class="text-[10px] font-bold uppercase text-black tracking-wider">${job.is_active ? 'Live' : 'Inactive'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function selectJob(id, title) {
            currentJobId = id;
            document.getElementById('target-job-title').innerText = `TARGET: ${title}`;
            fetchJobs(); // Update selection styling
            fetchPipeline(id);
        }

        async function fetchPipeline(jobId) {
            const container = document.getElementById('pipeline-container');
            container.innerHTML = '<div class="p-8 text-center font-mono text-xs text-gray-400 uppercase tracking-widest">QUERYING PIPELINE...</div>';

            try {
                const response = await fetch(`/api/applications/job/${jobId}`);
                const apps = await response.json();
                renderPipeline(apps);
            } catch (error) {
                console.error('Pipeline Error:', error);
            }
        }

        const userCache = {};

        async function renderPipeline(apps) {
            const container = document.getElementById('pipeline-container');
            if (apps.length === 0) {
                container.innerHTML = '<div class="p-12 text-center font-mono text-xs text-gray-400 uppercase tracking-widest">ZERO_APPLICANTS_DETECTED</div>';
                document.getElementById('signal-count').innerText = 'BUFFER: 0 SIGNALS';
                return;
            }

            let signalCount = 0;
            const rows = [];

            for (const app of apps) {
                // Fetch User Name if not in cache
                let seekerName = userCache[app.seeker_id] || `CAND-${app.seeker_id}`;
                if (!userCache[app.seeker_id]) {
                    try {
                        const userRes = await fetch(`/api/auth/profile/${app.seeker_id}`); // Assuming this exists or using a generic profile endpoint
                        const profile = await userRes.json();
                        seekerName = profile.full_name;
                        userCache[app.seeker_id] = profile.full_name;
                    } catch (e) {
                        // Fallback to searching in applications if needed or just use ID
                    }
                }

                // Check if session exists to enable "View Signals"
                const sessionRes = await fetch(`/api/applications/${app.id}/sessions`);
                const sessions = await sessionRes.json();
                const hasSession = sessions.length > 0;
                if (hasSession) signalCount++;

                const statusLabel = app.status === 'Applied' ? 'Raw_Data_Ready' : (app.status === 'Interview Required' ? 'Signal_Captured' : app.status);
                const statusClass = app.status === 'Interview Required' ? 'bg-black text-white' : 'border border-black text-black';

                rows.push(`
                    <div class="grid grid-cols-12 gap-4 px-4 py-4 items-center border-b border-black hover:bg-gray-50 transition-all group">
                        <div class="col-span-3 flex flex-col truncate">
                            <span class="font-mono text-sm font-bold text-black uppercase">${seekerName}</span>
                            <span class="text-[9px] text-gray-400 font-mono">ID: CAND-${app.seeker_id}-${app.id}</span>
                        </div>
                        <div class="col-span-3 font-mono text-sm text-gray-600">${new Date(app.created_at).toISOString().split('T')[0]}</div>
                        <div class="col-span-2">
                            <span class="text-[10px] font-mono px-2 py-1 uppercase ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="col-span-4 flex justify-end gap-3 italic">
                            ${app.resume_path ? `
                                <a href="/${app.resume_path.replace(/\\/g, '/')}" target="_blank" 
                                   class="tech-button-outline px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">description</span>
                                    Resume
                                </a>
                            ` : ''}
                            <button onclick="${hasSession ? `viewSignals(${app.id})` : ''}" 
                                    class="tech-button-outline px-4 py-1.5 text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 ${!hasSession ? 'opacity-30 cursor-not-allowed' : ''}">
                                <span class="material-symbols-outlined text-sm">visibility${!hasSession ? '_off' : ''}</span>
                                View Signals
                            </button>
                            ${app.status === 'Applied' ? `
                                <button onclick="updateStatus(${app.id}, 'Interview Required')" 
                                        class="tech-button-solid px-4 py-1.5 text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 shadow-none">
                                    <span class="material-symbols-outlined text-sm">check</span>
                                    Approve
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `);
            }

            container.innerHTML = rows.join('');
            document.getElementById('signal-count').innerText = `BUFFER: ${signalCount} SIGNALS`;
        }

        async function updateStatus(appId, status) {
            try {
                await fetch(`/api/applications/${appId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                if (currentJobId) fetchPipeline(currentJobId);
            } catch (error) {
                console.error('Status Update Error:', error);
            }
        }

        function viewSignals(appId) {
            window.location.href = `/replay?application_id=${appId}`;
        }

        // Initial load
        fetchJobs();
    </script>
</body>

</html>